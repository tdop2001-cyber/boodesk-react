# üéØ CONTEXTO BOODESK - CURSOR 94ESSSSSSSS                     4

## üìã PROJETO: BOODESK - Sistema de Gerenciamento de Tarefas

### üèóÔ∏è ARQUITETURA ATUAL
- **Frontend**: Tkinter GUI
- **Backend**: PostgreSQL + Supabase
- **Storage**: Cloudflare R2 + Supabase Storage
- **Real-time**: Supabase Realtime
- **Integra√ß√µes**: Google Calendar, Email

---

## ‚úÖ INTEGRA√á√ïES CONFIGURADAS

### üîó SUPABASE (FUNCIONANDO)
```python
# Configura√ß√£o atual em supabase_setup.py
SUPABASE_URL = "https://takwmhdwydujndqlznqk.supabase.co"
SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRha3dtaGR3eWR1am5kcWx6bnFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3ODQ3MDMsImV4cCI6MjA3MTM2MDcwM30.XUuRWmLrvNXfCI9PtD-2CR2y3NkxMFKRyQT_gbkuIhE"

# PostgreSQL
HOST = "db.takwmhdwydujndqlznqk.supabase.co"
DATABASE = "postgres"
USER = "postgres"
PASSWORD = "2412"
PORT = "5432"
```

### ‚òÅÔ∏è CLOUDFLARE R2 (CONFIGURADO - PRECISA CREDENCIAIS)
```python
# Endpoint configurado
R2_ENDPOINT = "https://d20101af9dd64057603c4871abeb1b0c.r2.cloudflarestorage.com"
BUCKET_NAME = "boodesk-uploads"

# Precisa configurar:
# R2_ACCESS_KEY_ID
# R2_SECRET_ACCESS_KEY
# CLOUDFLARE_ACCOUNT_ID
```

---

## üìä ESTRUTURA DO BANCO DE DADOS

### üóÑÔ∏è TABELAS PRINCIPAIS
```sql
-- Tabelas existentes no Supabase
members (id, name, email, phone, role, department, avatar_url, is_active)
users (id, username, email, password_hash, profile_image, role, created_at)
boards (id, title, description, owner_id, created_at, updated_at)
board_members (board_id, user_id, role, joined_at)
lists (id, board_id, title, position, created_at)
cards (id, list_id, title, description, position, due_date, priority, created_at)
card_members (card_id, user_id, role, assigned_at)
subtasks (id, card_id, title, description, assigned_to, created_by, status, created_at)
attachments (id, card_id, file_name, file_url, file_size, uploaded_by, uploaded_at)
comments (id, card_id, user_id, content, created_at)
activities (id, user_id, action_type, target_type, target_id, details, created_at)
chats (id, user1_id, user2_id, created_at)
messages (id, chat_id, sender_id, receiver_id, content, created_at)
notes (id, user_id, title, content, created_at, updated_at)
user_preferences (id, user_id, theme, notifications, language, created_at)
```

---

## üîß SISTEMAS IMPLEMENTADOS

### üì§ SISTEMA DE UPLOAD H√çBRIDO
```python
# sistema_upload_completo.py
class SistemaUploadCompleto:
    def __init__(self, supabase_url, supabase_key):
        # Configura Supabase e R2 automaticamente
    
    def upload_arquivo(self, file_path, folder):
        # Escolhe automaticamente entre Supabase (<50MB) e R2 (>50MB)
        # Retorna: {'success': True, 'url': 'url_do_arquivo', 'provider': 'supabase/r2'}
```

### üë• SISTEMA DE MEMBROS
```python
# Sistema completo de gerenciamento de equipe
# - CRUD de membros
# - Upload de avatares
# - Atribui√ß√£o a cards
# - Hist√≥rico de atividades
```

### üìÖ INTEGRA√á√ÉO COM CALEND√ÅRIO
```python
# Integra√ß√£o com Google Calendar
# - Sincroniza√ß√£o de tarefas
# - Lembretes autom√°ticos
# - Eventos de equipe
```

---

## üöÄ PADR√ïES DE DESENVOLVIMENTO

### üìÅ ORGANIZA√á√ÉO DE ARQUIVOS
```
uploads/
‚îú‚îÄ‚îÄ profile_images/     # Fotos de perfil (< 5MB ‚Üí Supabase)
‚îú‚îÄ‚îÄ card_attachments/   # Anexos de cards (< 50MB ‚Üí Supabase, > 50MB ‚Üí R2)
‚îú‚îÄ‚îÄ documents/          # Documentos (< 50MB ‚Üí Supabase, > 50MB ‚Üí R2)
‚îî‚îÄ‚îÄ temp/              # Arquivos tempor√°rios
```

### üîê SEGURAN√áA
- **Autentica√ß√£o**: Supabase Auth
- **Autoriza√ß√£o**: Row Level Security (RLS)
- **Uploads**: Valida√ß√£o de tipo e tamanho
- **Dados**: Criptografia em tr√¢nsito e repouso

### üé® INTERFACE
- **Tema**: Moderno e responsivo
- **Cores**: Azul (#2563eb), Verde (#10b981), Vermelho (#ef4444)
- **√çcones**: Material Design
- **Layout**: Grid responsivo

---

## ‚ö° COMANDOS R√ÅPIDOS PARA TESTE

### üîó Testar Supabase
```python
from supabase_setup import supabase_config
conn = supabase_config.get_connection()
print("‚úÖ Supabase OK" if conn else "‚ùå Erro")
```

### üì§ Testar Upload
```python
from sistema_upload_completo import SistemaUploadCompleto
sistema = SistemaUploadCompleto(supabase_url, supabase_key)
resultado = sistema.upload_arquivo("teste.txt", "testes")
print(f"Upload: {resultado['success']} via {resultado['provider']}")
```

### üë• Testar Membros
```python
# Verificar sistema de membros
cursor = conn.cursor()
cursor.execute("SELECT COUNT(*) FROM members")
print(f"Membros: {cursor.fetchone()[0]}")
```

---

## üéØ REGRAS DE DESENVOLVIMENTO

### ‚úÖ SEMPRE FAZER
1. **Usar integra√ß√µes existentes** (Supabase + R2)
2. **Validar uploads** (tipo, tamanho, seguran√ßa)
3. **Implementar RLS** para novas tabelas
4. **Testar conex√µes** antes de deploy
5. **Documentar mudan√ßas** no c√≥digo
6. **Implementar isolamento por usu√°rio** (RLS obrigat√≥rio)
7. **Validar permiss√µes** em todas as opera√ß√µes
8. **Separar dados por usu√°rio** automaticamente
9. **Verificar widgets antes de configur√°-los** (evitar erros NoneType)
10. **Usar get_connection() em vez de connection direto**
11. **N√£o chamar create_widgets() durante inicializa√ß√£o da classe**

### ‚ùå NUNCA FAZER
1. **Upload local** (sempre na nuvem)
2. **JSON local** (usar Supabase)
3. **Hardcode credenciais** (usar .env)
4. **Ignorar valida√ß√µes** de seguran√ßa
5. **Quebrar compatibilidade** existente
6. **Expor dados de outros usu√°rios**
7. **Ignorar controle de acesso**
8. **Permitir acesso sem autentica√ß√£o**
9. **Acessar widgets sem verificar se existem**
10. **Usar self.db.connection diretamente**
11. **Chamar create_widgets() durante __init__**

---

## üé® PADR√ïES DE INTERFACE - TELAS DE CONFIGURA√á√ÉO

### ‚úÖ SEMPRE USAR
1. **Layout**: `pack()` em vez de `grid()` para telas de configura√ß√£o
2. **Container**: Frame principal com `pack(fill='both', expand=True, padx=20, pady=20)`
3. **Se√ß√µes**: `LabelFrame` para agrupar configura√ß√µes relacionadas
4. **Espa√ßamento**: `pady=(0, 15)` entre se√ß√µes, `pady=(20, 0)` antes de bot√µes
5. **Bot√µes**: Sempre no final, alinhados √† direita com `pack(side='right')`
6. **Estilo**: Usar `Accent.TButton` para bot√µes principais

### üìã ESTRUTURA PADR√ÉO
```python
def create_tab_name(self):
    frame = self.tab_name
    
    # Container principal
    main_container = ttk.Frame(frame)
    main_container.pack(fill='both', expand=True, padx=20, pady=20)
    
    # Se√ß√£o 1
    section1_frame = ttk.LabelFrame(main_container, text="T√≠tulo da Se√ß√£o", padding=10)
    section1_frame.pack(fill='x', pady=(0, 15))
    
    # Widgets da se√ß√£o...
    
    # Se√ß√£o 2
    section2_frame = ttk.LabelFrame(main_container, text="Outra Se√ß√£o", padding=10)
    section2_frame.pack(fill='x', pady=(0, 15))
    
    # Widgets da se√ß√£o...
    
    # Bot√£o de atualizar
    button_frame = ttk.Frame(main_container)
    button_frame.pack(fill='x', pady=(20, 0))
    
    ttk.Button(button_frame, text="Atualizar", command=self.save_settings, 
               style='Accent.TButton').pack(side='right')
```

### üîß CONFIGURA√á√ïES JSON
1. **Fun√ß√£o auxiliar**: Sempre usar `_get_safe_dict_setting()` para configura√ß√µes JSON
2. **Tratamento**: Converter strings JSON para dicion√°rios automaticamente
3. **Fallback**: Valores padr√£o em caso de erro na deserializa√ß√£o
4. **Salvamento**: Sempre salvar dicion√°rios completos, n√£o strings

### üéØ REGRAS OBRIGAT√ìRIAS
- ‚ùå NUNCA usar `grid()` em telas de configura√ß√£o
- ‚ùå NUNCA acessar `self.app.settings["key"].items()` diretamente
- ‚úÖ SEMPRE usar `pack()` para layout
- ‚úÖ SEMPRE usar `_get_safe_dict_setting()` para JSON
- ‚úÖ SEMPRE incluir bot√£o "Atualizar" no final
- ‚úÖ SEMPRE usar `LabelFrame` para organizar se√ß√µes

---

## üîê SISTEMA DE ISOLAMENTO POR USU√ÅRIO

### üë§ **ISOLAMENTO OBRIGAT√ìRIO**
- **Usu√°rio comum**: V√™ apenas seus pr√≥prios dados
- **Admin**: Acesso amplo a todos os dados
- **RLS**: Row Level Security em todas as tabelas
- **Autentica√ß√£o**: Obrigat√≥ria para todas as opera√ß√µes

### üìä **VISUALIZA√á√ÉO POR USU√ÅRIO**

#### **üë§ USU√ÅRIO COMUM**
```sql
-- Quadros: Apenas onde participa
SELECT * FROM boards WHERE id IN (
    SELECT board_id FROM board_members WHERE user_id = auth.uid()
)

-- Cards: Apenas onde participa
SELECT * FROM cards WHERE id IN (
    SELECT card_id FROM card_members WHERE user_id = auth.uid()
)

-- Subtasks: V√™ todas do card, mas s√≥ edita as suas
SELECT * FROM subtasks WHERE card_id IN (
    SELECT card_id FROM card_members WHERE user_id = auth.uid()
)
-- Edi√ß√£o: Apenas subtasks criadas pelo usu√°rio
```

#### **üëë ADMIN**
```sql
-- Acesso completo a todos os dados
SELECT * FROM boards
SELECT * FROM cards  
SELECT * FROM subtasks
SELECT * FROM users
```

### üí¨ **CHATS E MENSAGENS**
```sql
-- Usu√°rio v√™ apenas:
-- 1. Chats onde participa
-- 2. Suas pr√≥prias mensagens
-- 3. Mensagens direcionadas a ele

-- Chats privados
SELECT * FROM chats WHERE 
    user1_id = auth.uid() OR user2_id = auth.uid()

-- Mensagens do usu√°rio
SELECT * FROM messages WHERE 
    sender_id = auth.uid() OR receiver_id = auth.uid()
```

### üìÅ **UPLOADS E ARQUIVOS**
```sql
-- Usu√°rio v√™ apenas:
-- 1. Seus pr√≥prios uploads
-- 2. Uploads de cards onde participa (somente leitura)
-- 3. Uploads compartilhados com ele

-- Uploads pessoais
SELECT * FROM attachments WHERE 
    uploaded_by = auth.uid()

-- Uploads de cards (somente leitura)
SELECT * FROM attachments WHERE 
    card_id IN (SELECT card_id FROM card_members WHERE user_id = auth.uid())
```

### üìù **ANOTA√á√ïES E DADOS INDIVIDUAIS**
```sql
-- Usu√°rio v√™ apenas suas anota√ß√µes
SELECT * FROM notes WHERE 
    user_id = auth.uid()

-- Dados pessoais
SELECT * FROM user_preferences WHERE 
    user_id = auth.uid()

-- Hist√≥rico pessoal
SELECT * FROM activities WHERE 
    user_id = auth.uid()
```

### üéØ **REGRAS DE ACESSO**

#### **‚úÖ PERMITIDO (USU√ÅRIO COMUM)**
- Ver quadros onde participa
- Ver cards onde participa  
- Ver subtasks de companheiros (somente leitura)
- Editar suas pr√≥prias subtasks
- Ver suas mensagens e chats
- Ver seus uploads
- Ver suas anota√ß√µes
- Ver seu hist√≥rico

#### **‚ùå PROIBIDO (USU√ÅRIO COMUM)**
- Ver quadros de outros usu√°rios
- Ver cards onde n√£o participa
- Editar subtasks de outros
- Ver mensagens de outros
- Ver uploads de outros
- Ver anota√ß√µes de outros
- Acessar dados de outros usu√°rios

#### **üëë ADMIN (ACESSO TOTAL)**
- Ver todos os quadros
- Ver todos os cards
- Editar qualquer subtask
- Ver todas as mensagens
- Ver todos os uploads
- Ver todas as anota√ß√µes
- Gerenciar usu√°rios
- Acessar logs do sistema

---

## üîí IMPLEMENTA√á√ÉO RLS (ROW LEVEL SECURITY)

### **üìã POL√çTICAS OBRIGAT√ìRIAS**

#### **1. TABELA USERS**
```sql
-- Usu√°rio v√™ apenas seu pr√≥prio perfil
CREATE POLICY "users_own_profile" ON users
    FOR ALL USING (id = auth.uid());

-- Admin v√™ todos os usu√°rios
CREATE POLICY "admin_all_users" ON users
    FOR ALL USING (
        EXISTS (SELECT 1 FROM users WHERE id = auth.uid() AND role = 'admin')
    );
```

#### **2. TABELA BOARDS**
```sql
-- Usu√°rio v√™ quadros onde participa
CREATE POLICY "boards_user_access" ON boards
    FOR ALL USING (
        id IN (SELECT board_id FROM board_members WHERE user_id = auth.uid())
        OR owner_id = auth.uid()
    );
```

#### **3. TABELA CARDS**
```sql
-- Usu√°rio v√™ cards onde participa
CREATE POLICY "cards_user_access" ON cards
    FOR ALL USING (
        id IN (SELECT card_id FROM card_members WHERE user_id = auth.uid())
        OR list_id IN (
            SELECT list_id FROM lists WHERE board_id IN (
                SELECT board_id FROM board_members WHERE user_id = auth.uid()
            )
        )
    );
```

#### **4. TABELA SUBTASKS**
```sql
-- Usu√°rio v√™ todas as subtasks do card, mas s√≥ edita as suas
CREATE POLICY "subtasks_view_access" ON subtasks
    FOR SELECT USING (
        card_id IN (SELECT card_id FROM card_members WHERE user_id = auth.uid())
    );

CREATE POLICY "subtasks_edit_own" ON subtasks
    FOR UPDATE USING (created_by = auth.uid());
```

#### **5. TABELA MESSAGES**
```sql
-- Usu√°rio v√™ apenas suas mensagens
CREATE POLICY "messages_user_access" ON messages
    FOR ALL USING (
        sender_id = auth.uid() OR receiver_id = auth.uid()
    );
```

#### **6. TABELA ATTACHMENTS**
```sql
-- Usu√°rio v√™ seus uploads e uploads de cards onde participa
CREATE POLICY "attachments_user_access" ON attachments
    FOR ALL USING (
        uploaded_by = auth.uid()
        OR card_id IN (SELECT card_id FROM card_members WHERE user_id = auth.uid())
    );
```

### **üîß FUN√á√ÉO DE VERIFICA√á√ÉO DE PERMISS√ïES**
```sql
-- Fun√ß√£o para verificar se usu√°rio √© admin
CREATE OR REPLACE FUNCTION is_admin()
RETURNS BOOLEAN AS $$
BEGIN
    RETURN EXISTS (
        SELECT 1 FROM users 
        WHERE id = auth.uid() AND role = 'admin'
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Fun√ß√£o para verificar acesso ao card
CREATE OR REPLACE FUNCTION has_card_access(card_id_param INTEGER)
RETURNS BOOLEAN AS $$
BEGIN
    RETURN EXISTS (
        SELECT 1 FROM card_members 
        WHERE card_id = card_id_param AND user_id = auth.uid()
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

---

## üîß DEPEND√äNCIAS ESSENCIAIS
```bash
pip install supabase boto3 python-dotenv pillow psycopg2-binary
```

## üìö DOCUMENTA√á√ÉO COMPLETA
- **Manual**: `MANUAL_DESENVOLVIMENTO_BOODESK.md`
- **Guia**: `GUIA_INTEGRACOES_EXISTENTES.md`
- **Resumo**: `RESUMO_INTEGRACOES.md`
- **Instala√ß√£o**: `README_INSTALACAO.md`

---

## üéØ FOCO ATUAL
- **Prioridade 1**: Testar tela de configura√ß√µes (bot√µes no topo)
- **Prioridade 2**: Configurar credenciais R2
- **Prioridade 3**: Testar sistema h√≠brido completo
- **Prioridade 4**: Implementar funcionalidades avan√ßadas
- **Prioridade 5**: Otimizar performance

## üêõ CORRE√á√ïES DE BUGS RECENTES

### ‚úÖ PROBLEMAS RESOLVIDOS
1. **IndentationError no database_postgres.py** - C√≥digo duplicado removido
2. **AttributeError 'tk' na BoodeskApp** - create_widgets() movido para momento correto
3. **DatabasePostgres sem m√©todo connection** - Adicionado get_connection()
4. **NoneType errors em widgets** - Verifica√ß√µes de exist√™ncia implementadas
5. **JSON deserialization errors** - Configura√ß√µes corrigidas no banco

### üîß PADR√ïES DE CORRE√á√ÉO
```python
# SEMPRE verificar widgets antes de usar
if hasattr(self, 'widget_name') and self.widget_name is not None:
    self.widget_name.config(text="texto")

# SEMPRE usar get_connection() em vez de connection
self.calendar_manager = CalendarEventManager(self.db.get_connection())

# NUNCA chamar create_widgets() durante __init__
# Deve ser chamado ap√≥s inicializa√ß√£o completa
```

---

**üí° DICA**: Sempre consulte os manuais na pasta `BOODESK_MANUAIS` no Desktop para detalhes completos!
